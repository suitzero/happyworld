<!DOCTYPE html>
<script id="f" type="x/f">
#ifdef GL_ES
precision mediump float;
#endif


uniform float t;
uniform vec2 mouse;
uniform vec2 r;
uniform float pitch;

vec3 iMouse=vec3(t*50.0);
vec2 iResolution=r;
float iGlobalTime=t;



// main
void main(){
    vec4 o2 = gl_FragCoord/iResolution.xyxx-.5, d=o2, r1, z;
    float t = iGlobalTime, c;
    o2.z += t;
    for(int i=0; i<60; i++){
       	r1 = cos(o2+ o2.w*sin(t)*0.9);
        c = dot(r1.xyz, r1.xyz);
        r1 = cos(r1/c*6.*-pitch*t);
        r1.x = dot(r1.zy, r1.zy)*c;
        o2 -= d*r1.x*.2;
        z += abs(sin(vec4(9,0,1,1)+(o2.y + t + o2.w)))*.12*c/(o2.w*o2.w+ 6.);
    }
    gl_FragColor = z*z*z;
	gl_FragColor.w = 0.7+gl_FragColor.w;
}


</script>
<script id="v" type="x/v">
attribute vec3 p;void main(){gl_Position=vec4(p,1.);}
</script>
<script src="http://www.keithwhor.com/music/audiosynth.js"></script>
<script>
w=window;
w.onload=function(){
	b=function(s){
		return document.getElementById(s)
	};
	w.addEventListener('keydown',k,1);
	c=b('c');
	g=c.getContext('webgl');
	p=g.createProgram();
	addShader=function(i,j){
		k=g.createShader(35633-i); // VERTEX_SHADER: 35633 FRAGMENT_SHADER: 35632
		g.shaderSource(k,j);
		g.compileShader(k);
		g.attachShader(p,k);
		return g.getShaderInfoLog(k);
	};
	if(!addShader(0,b('v').text)&&!addShader(1,b('f').text))
	{
		g.linkProgram(p);
	}
	e=g.getProgramParameter(p, 35714);
	g.useProgram(p);
	u={};
	u.t=g.getUniformLocation(p,'t');
	u.r=g.getUniformLocation(p,'r');
	u.pitch = g.getUniformLocation(p,'pitch');
	g.bindBuffer(34962,g.createBuffer()); // ARRAY_BUFFER: 34962
	g.bufferData(34962,new Float32Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]),35044); // STATIC_DRAW: 35044
	a=g.getAttribLocation(p,'p');
	g.enableVertexAttribArray(a);
	g.vertexAttribPointer(a,3,5126,0,0,0); //VERTEX_ATTRIB_ARRAY_TYPE: 5126
	g.clearColor(0,0,0,1);
	z=Date.now();
	var penta = ['G', 'A', 'B', 'D', 'E', 'G'];
	var piano = Synth.createInstrument('piano');
	var acous = Synth.createInstrument('acoustic');
	
	var last =(Date.now()-z)*.001;;
	(function(){
		if(!e){return;}

	
		c.width=x=w.innerWidth;
		c.height=y=w.innerHeight;
		g.viewport(0,0,x,y);
		d=(Date.now()-z)*.001;
		pitch = 0;
		if(d-last>0.25)
		{
			last =d;
			var soloi = Math.floor(Math.random()*10%penta.length);
			if (Math.floor(Math.random()*10)%2==0)
			{
				piano.play(penta[soloi], 4, 2);
				pitch = soloi*0.1;
			}
			if (Math.floor(Math.random()*10)%5==0)
			{
				Synth.setVolume(0.30);
				var soloi = Math.floor(Math.random()*10%penta.length);
				acous.play(penta[soloi], 2, 3);
				Synth.setVolume(1.);
			}
			var soloi = Math.floor(Math.random()*10%penta.length);
		}		
		g.clear(16384); // COLOR_BUFFER_BIT: 16384
		g.uniform1f(u.t,d);
		g.uniform2fv(u.r,[x,y]);
		if (pitch)
		{
			g.uniform1f(u.pitch,pitch);
		}
		g.drawArrays(g.TRIANGLE_STRIP,0,4);
		g.flush();

		requestAnimationFrame(arguments.callee);
	})();
	function k(h){e=(h.keyCode!==27);}};
</script>
<style>*{margin:0;padding:0;overflow:hidden}html,body{height:100%}</style>
<canvas id="c"></canvas>
